apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: codes.db.amazee.ai
spec:
  group: db.amazee.ai
  names:
    kind: NoSQL
    plural: codes
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              location:
                type: string
                oneOf:
                - pattern: '^EU$'
                - pattern: '^US$'
            required:
            - location
    served: true
    referenceable: true
  claimNames:
    kind: NoSQLClaim
    plural: codeclaim
---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: ddb-validation-codes
spec:
  mode: Pipeline
  pipeline:
  - step: patch-and-transform
    functionRef:
      name: function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
      - name: dynamoDB
        base:
          apiVersion: dynamodb.aws.upbound.io/v1beta1
          kind: Table
          spec:
            forProvider:
              region: "us-east-2"
              writeCapacity: 1
              readCapacity: 1
              billingMode: PAY_PER_REQUEST
              deletionProtectionEnabled: true
              attribute:
                - name: email
                  type: S
              hashKey: email
              ttl:
                enabled: true
                attributeName: ttl
        patches:
          - type: FromCompositeFieldPath
            fromFieldPath: "spec.location"
            toFieldPath: "spec.forProvider.region"
            transforms:
            - type: map
              map:
                EU: "eu-west-1"
                US: "us-east-2"
  compositeTypeRef:
    apiVersion: db.amazee.ai/v1alpha1
    kind: NoSQL